using Manifolds, Test, Random, LinearAlgebra, FiniteDifferences

# Manifolds to test
Ms = [
    Segre(10),
    Segre(7, 2),
    Segre(7, 9, 9),
    Segre(9, 3, 6, 6),
    MetricManifold(Segre(10), WarpedMetric{1.2025837056880606}()),
    MetricManifold(Segre(2, 9), WarpedMetric{1.1302422072971439}()),
    MetricManifold(Segre(9, 6, 10), WarpedMetric{1.4545138169484464}()),
    MetricManifold(Segre(9, 3, 8, 10), WarpedMetric{1.396673190458706}()),
]

# Vs[i] is the valence of Ms[i]
Vs = [(10,), (7, 2), (7, 9, 9), (9, 3, 6, 6), (10), (2, 9), (9, 6, 10), (9, 3, 8, 10)]

# ps[i] is a point on Ms[i]
ps = [
    [
        [0.4679314536763416],
        [
            -0.317396495862958,
            0.09740239786995583,
            -0.03435690079466174,
            -0.507098294482249,
            -0.3456993992812562,
            0.03370180478069075,
            0.12197903860091835,
            -0.19063489706041362,
            -0.6772451984545433,
            -0.030292993087650443,
        ],
    ],
    [
        [1.5024828708442504],
        [
            -0.20674979086955983,
            0.006156775886150006,
            -0.3570727686996312,
            -0.02472149296318015,
            -0.8820637035264094,
            -0.19877726490312608,
            0.10749756092041758,
        ],
        [0.13573491868289245, 0.9907451901726038],
    ],
    [
        [0.5567549635823631],
        [
            0.20108807178297264,
            0.11422009200726954,
            -0.4229195164047098,
            0.8118482504243884,
            -0.2985123290622806,
            -0.10304198468607091,
            0.0939765805139303,
        ],
        [
            0.04424901152619659,
            -0.7169306819079923,
            -0.031129292324036512,
            0.6372250118096429,
            -0.02583896509973039,
            0.014153747195613426,
            0.16225623748001994,
            -0.11092394734951527,
            0.19372269982536366,
        ],
        [
            0.42796852361059873,
            0.1000612228302854,
            -0.6494403216595616,
            0.012394320858700462,
            -0.44765471097923526,
            0.28788160552521874,
            0.26926315361113184,
            0.14434420119149496,
            0.09108177932795573,
        ],
    ],
    [
        [0.13874530878036045],
        [
            0.22313639103335817,
            -0.582683687448744,
            0.019810748294280565,
            -0.532091804219692,
            0.4183784535017075,
            0.14178309829111962,
            -0.20220724006960822,
            0.29098277220121593,
            0.08046116169937856,
        ],
        [0.9267624891781729, -0.13156790592635095, 0.35185391113703934],
        [
            -0.20128032438008028,
            -0.8385905159101716,
            0.32092863797763976,
            -0.004535145988646948,
            0.2201729511393691,
            -0.3236669445683654,
        ],
        [
            -0.4807744861170881,
            -0.7965214809133648,
            0.05085093394774735,
            -0.18228152610151416,
            -0.3136581939724126,
            -0.014682951172671068,
        ],
    ],
    [
        [1.1838757652294163],
        [
            0.210872386528422,
            0.07121151449265378,
            -0.5646662541775129,
            0.3616416663029674,
            0.06637879222702027,
            0.07584789624963773,
            -0.5828313418578935,
            0.2675952004007925,
            0.22734623628568493,
            0.16638557775398255,
        ],
    ],
    [
        [1.2844162220009774],
        [-0.30842015389728145, 0.951250234517699],
        [
            0.30279327531038325,
            0.08852690888227953,
            0.05590206678861999,
            -0.11020418544430191,
            0.34622673649276936,
            0.039237251633264296,
            0.2036788352046126,
            0.7474907644209177,
            -0.4044368794841003,
        ],
    ],
    [
        [0.5007028223906543],
        [
            -0.06769241297456885,
            -0.5449485746545011,
            0.398606571568952,
            0.6501033139153659,
            -0.04258821690222594,
            -0.13267612920115782,
            0.28917066939208946,
            -0.0862022715614269,
            0.08037444499516286,
        ],
        [
            -0.435703924552393,
            0.003588856443541161,
            -0.6651813230937048,
            0.2132673584452006,
            -0.23794057413100464,
            -0.5153487505082289,
        ],
        [
            0.10026563183607826,
            -0.41453578717039885,
            0.22729656824470607,
            -0.4898014879827773,
            0.3079502543279662,
            0.32626734055020185,
            0.22241280421779944,
            -0.20185051232763798,
            0.26385177592505493,
            -0.4067248155023813,
        ],
    ],
    [
        [0.18481028402754704],
        [
            0.3100324954044331,
            0.20571167887073383,
            0.2759549800636245,
            -0.5098047663273968,
            -0.40513901097801985,
            -0.006849531735112356,
            0.32426009440794523,
            0.0980343539650855,
            0.496558786543343,
        ],
        [0.7400543367573574, -0.6634600702609377, -0.11018309224186618],
        [
            -0.3047981091301781,
            -0.2991724005041669,
            -0.180567141067543,
            -0.46275630707119686,
            0.5780573143957574,
            0.04795327307127396,
            0.27896164368216786,
            -0.3956977653578857,
        ],
        [
            -0.5375940335785957,
            -0.33527871549213856,
            -0.34423023822843113,
            -0.057618837476544824,
            0.2307053118861316,
            -0.5816558302641435,
            0.1347923363882464,
            0.005386448290725161,
            0.17361223551501662,
            -0.19203856057632393,
        ],
    ],
]

# qs[i] is a point on Ms[i] that is connected to ps[i] by a geodesic and uses the closest representative to ps[i]
qs = [
    [
        [0.2285468999681258],
        [
            0.0072000169737206285,
            0.46919050788513217,
            -0.0578728225972693,
            0.14417171957969074,
            0.5393873747379379,
            0.3535952408499787,
            -0.19179220675967715,
            0.0603486044844522,
            -0.3902812557079805,
            0.38335320681028,
        ],
    ],
    [
        [0.9263875479802128],
        [
            -0.2876490379709154,
            0.5934703502895091,
            0.00669105544965959,
            -0.5238009412763243,
            0.48771046854635186,
            0.22195505041284128,
            0.05927252688380565,
        ],
        [-0.8467814852966212, 0.5319408953623024],
    ],
    [
        [0.05929877942048794],
        [
            -0.2492472329981639,
            0.19078207722614024,
            -0.6950020535594956,
            0.6155692112895002,
            0.12163736596071065,
            0.07617216946811589,
            -0.13757492254479187,
        ],
        [
            -0.3446138929389734,
            -0.44528715923871226,
            0.09867730315307487,
            0.3856741902911293,
            -0.03976898819561624,
            -0.09854548801276108,
            0.5786967392957476,
            0.419483004838766,
            -0.048271382271637374,
        ],
        [
            -0.13898349823957276,
            0.37007148419755803,
            -0.5672020653516858,
            0.2664429979574558,
            0.26019214805889984,
            -0.183973837333837,
            -0.537331406376888,
            -0.2092584392846679,
            -0.13023121083469708,
        ],
    ],
    [
        [0.5944460845919239],
        [
            0.18440528974038717,
            -0.3234774292705488,
            -0.07521274368923382,
            -0.5055464117085976,
            0.17461559395815557,
            0.20174607290008786,
            -0.5921554567742019,
            0.22060599004214254,
            0.3600218594053353,
        ],
        [0.9391716922907767, -0.20920363981570536, -0.27237909150215467],
        [
            0.594536709760007,
            -0.6154768837189905,
            0.2868298100684849,
            0.08944875927641796,
            0.42003473849671874,
            0.031823015747801525,
        ],
        [
            0.04047760394645142,
            0.5651446411453817,
            0.4996377449872775,
            0.5242952935259201,
            -0.18199312205158755,
            -0.34832193537003325,
        ],
    ],
    [
        [0.9068920036691095],
        [
            0.028598193298964708,
            0.4294897666239807,
            0.5582305652867099,
            0.20015138065027618,
            -0.36032666340358765,
            -0.06085371828646839,
            0.3481371808459643,
            0.3824819666832563,
            0.15057862863095645,
            0.19832899484009994,
        ],
    ],
    [
        [1.8900272913460916],
        [-0.24462417095922365, 0.9696179737311559],
        [
            0.0029148214868594184,
            0.046733730849394826,
            0.3464166332779196,
            -0.41612585782053313,
            0.4403234930433767,
            -0.07014699792539351,
            -0.6626027503215617,
            0.06409791188610743,
            -0.25037156781949155,
        ],
    ],
    [
        [1.3388920951283048],
        [
            -0.2894849285247092,
            -0.375237468281043,
            0.10659685105991663,
            0.5326935539788507,
            -0.2687936085300003,
            -0.28583226069914086,
            -0.06940771783985483,
            0.566949781731537,
            0.0083926101085135,
        ],
        [
            -0.2692873331242094,
            -0.352948146454535,
            -0.36201078692503574,
            0.26291906209331745,
            -0.430264386434885,
            -0.6462246148490923,
        ],
        [
            -0.2899662461053266,
            0.561676369276759,
            0.29953621040966766,
            0.026981212635263388,
            -0.1879070254370779,
            -0.10235375900374745,
            -0.04777542564881818,
            -0.6562458092558364,
            0.02736625708068412,
            -0.17468256196490237,
        ],
    ],
    [
        [0.5595013700016621],
        [
            -0.16410496932023275,
            0.2124425044194968,
            0.019103430387761126,
            -0.49321855967754313,
            0.2187406652190155,
            -0.2438450092656317,
            -0.29126737061752705,
            -0.6546701444600094,
            0.2521323190300214,
        ],
        [0.5091077043894671, -0.7810695653023092, -0.36157942348777083],
        [
            0.09792086442785906,
            -0.46300382891140285,
            -0.34321497128243517,
            -0.4715033116632154,
            0.23250354333074766,
            0.3343541579831825,
            0.33398745563364823,
            -0.39815681352786747,
        ],
        [
            0.1472380561455175,
            -0.2928950599225513,
            -0.06829513714619305,
            0.2630794095929546,
            -0.07520704498840525,
            -0.097452294891074,
            0.1546325256973868,
            -0.7547590605905541,
            0.42527618176727117,
            -0.17050835599699163,
        ],
    ],
]

# vs[i] is a tangent vector to Ms[i] at ps[i] such that exp(Ms[i], ps[i], t * vs[i]) is the closes representative to ps[i] for t in [-1, 1]
vs = [
    [
        [0.6940789907123062],
        [
            0.14913995456500687,
            -0.030547142938236793,
            0.31162623436384285,
            -0.20563967625033036,
            0.19319043822673818,
            0.317062500120066,
            -0.8754858218076765,
            -0.3259209038205042,
            -0.033243255319008624,
            -1.1548635082931478,
        ],
    ],
    [
        [0.45470843046349313],
        [
            0.433513329547113,
            -0.7320515075884788,
            -0.38765391945909755,
            0.19640702045402264,
            0.14944186690806377,
            -0.9671407596317976,
            -0.9289295848779034,
        ],
        [-0.5045110500803344, 0.06911945375717096],
    ],
    [
        [-0.14362437882603868],
        [
            0.21703580244995338,
            -0.07582942569056315,
            -0.4131524696769127,
            0.07113227925464494,
            0.9216831076067749,
            -0.3117658924120991,
            -0.2601938828890881,
        ],
        [
            -0.40993096871840384,
            0.06033520676657045,
            0.3353505686920585,
            0.32669207217743906,
            -0.26949939576113957,
            0.4622586254534011,
            -0.23046667729151138,
            0.39890816877066293,
            -0.352075854880814,
        ],
        [
            0.27574595870419494,
            -0.20132897843112602,
            0.7181884086912088,
            0.20902304397906357,
            -0.9797911979282492,
            -0.22738728408774556,
            -0.08434852248139064,
            -0.03906999050989374,
            0.23241083119724726,
        ],
    ],
    [
        [-0.10835780918855986],
        [
            -0.2879956140065193,
            0.43075721925722893,
            -0.3291055923326802,
            0.017387780693294552,
            0.060086501392198954,
            -0.22944578876172467,
            -0.2678362137267055,
            0.821848362075142,
            0.5607641072034037,
        ],
        [0.1257205818761756, 0.5344739830694265, -0.1312860116480018],
        [
            -0.32028258895073813,
            0.05581149125388041,
            -0.38726569273936556,
            -0.4124721885803405,
            0.09543462429188473,
            -0.2587175245909177,
        ],
        [
            0.23313088537058163,
            0.398484868218528,
            0.17079789329674128,
            -0.5464610930958373,
            -1.0423151616550292,
            0.3909668100967531,
        ],
    ],
    [
        [-0.25050034943799143],
        [
            0.3488629827096742,
            -0.01790447096652751,
            0.41078746198742494,
            0.2674738658616262,
            -0.3676063246452534,
            0.27995679376647054,
            -0.6476807696598814,
            -0.05608263854802896,
            -1.002407614041255,
            -0.41159169074078095,
        ],
    ],
    [
        [0.7638265778356526],
        [0.043718096583251764, 0.014174547965435269],
        [
            0.1589574325807131,
            0.8748133883099838,
            -0.3528071207217161,
            -0.2644899757823254,
            0.24010835273681236,
            -0.1673897092037622,
            -0.6222042985569745,
            -0.09191448012128656,
            0.039882538236865134,
        ],
    ],
    [
        [-0.2827629165886028],
        [
            -0.5431768324825607,
            -0.2133080279346807,
            -0.10499961310795408,
            0.09083087776121102,
            0.37394345246532357,
            0.41219715056530515,
            -0.17844896356814216,
            0.6017127772767268,
            0.04825845645947814,
        ],
        [
            0.1686105642978755,
            0.27823583527578005,
            -0.06479699938479212,
            0.4075789329243761,
            -0.1242362543997863,
            0.16905085277591742,
        ],
        [
            0.4498529143568951,
            -0.38162629109703405,
            -0.6140545422956211,
            0.15825503736095084,
            -0.2582602332898444,
            0.7274993022330352,
            -0.2411292264007391,
            -0.5521909388447415,
            -0.32703914771404785,
            0.28418328300445966,
        ],
    ],
    [
        [-0.13762858893746074],
        [
            -0.44703815295307797,
            0.5944800147380626,
            1.4927738811624347,
            0.2690676585035225,
            0.1392293231358478,
            -0.40920070507884104,
            -0.7332317211680289,
            -0.3830957876846897,
            0.1418909392355959,
        ],
        [-0.28919223043248377, -0.334256240757651, 0.07031663871919733],
        [
            1.4923062450401439,
            -0.07045305045420008,
            1.1439824974086474,
            -0.48836659931427834,
            0.9029762904802794,
            -0.4051626818191545,
            0.7052172856721804,
            0.7200604408974567,
        ],
        [
            -0.4660428754709174,
            0.3303812040550049,
            0.0416448317248993,
            0.0923448025024135,
            -0.11839363942123281,
            0.12128945856537898,
            -0.3046909560916853,
            -0.9180764335769804,
            -0.8185102432606277,
            -0.8637091370051597,
        ],
    ],
]

# us[i] is a tangent vector to Ms[i] at ps[i]
us = [
    [
        [-0.37772914799158225],
        [
            -0.59695867308892,
            0.3750933177933997,
            0.34564315403507745,
            0.046043813336741984,
            -0.0545409875155681,
            0.2577121584084208,
            -0.3308621558840682,
            0.15972331014082508,
            0.23275600794660842,
            -0.33394550809020124,
        ],
    ],
    [
        [-0.2603225446842325],
        [
            0.3602679784109386,
            0.17337068990715637,
            -0.19313197776041668,
            -0.25410123672991486,
            0.08222041883237792,
            -0.21642611657517966,
            0.2574667569083157,
        ],
        [1.3205385203894777, -0.18091754616690692],
    ],
    [
        [-0.14766117733667908],
        [
            -1.0051180880053472,
            0.9460677967957836,
            0.5835821685582908,
            0.6948551934342009,
            0.6374252884087097,
            -0.009680426176410788,
            -0.36146835559128143,
        ],
        [
            0.4688516869504158,
            -0.28425151202447,
            -0.3187195701047898,
            -0.35633492041750464,
            0.554715750802327,
            -0.10721116773599117,
            0.28645702408100504,
            -0.1610220090851739,
            -0.28845747034499986,
        ],
        [
            0.09417372769886223,
            0.1989812337413881,
            -0.08400464069697863,
            -0.6790036003882072,
            -0.22919842842946442,
            0.3185935243022103,
            -0.9397877219225759,
            -0.548382602086301,
            0.3462072647694016,
        ],
    ],
    [
        [-0.8237610837914967],
        [
            0.3004390493463726,
            0.4405860908850111,
            -0.7157767786794753,
            -0.26422248721975317,
            0.43563297876352225,
            -0.05301527548401603,
            0.2653406121711885,
            -0.16921344490396534,
            -0.10660913986306259,
        ],
        [0.2301095438238535, 0.13543635311552182, -0.5554515952958057],
        [
            -0.047141475305190236,
            0.26349478946841576,
            0.7660038342835548,
            -0.44707592462720674,
            -0.008237239351391848,
            0.10681017970047482,
        ],
        [
            -0.10101942119876328,
            -0.09752768648570287,
            -0.03101236164578546,
            -0.017267002331470507,
            0.426143631920239,
            -0.3979129485173604,
        ],
    ],
    [
        [-0.11566741406383592],
        [
            -0.6189044291634334,
            -0.4887938523139652,
            0.377907148579411,
            0.4086524760594208,
            0.07938663795474155,
            -0.6960459002055371,
            -0.5157245121702985,
            -0.0949098978719522,
            0.35850803987739277,
            -0.4702399492568731,
        ],
    ],
    [
        [-0.44426957903450753],
        [0.02248238255936011, 0.0072893752214958085],
        [
            -0.11483810063446695,
            0.7180538788465062,
            1.2336105712455359,
            0.5094984474406282,
            0.44539460730056,
            -0.22600080346686421,
            0.23177494146123226,
            0.04078051728077603,
            0.6543369295727094,
        ],
    ],
    [
        [0.26115469823295706],
        [
            0.9332535998779934,
            0.8409422500428906,
            1.1570765490059969,
            0.009748111907376684,
            0.1823249755535606,
            0.42856570496684815,
            0.5854663071660117,
            0.3272130825134361,
            -0.2809222008539077,
        ],
        [
            -0.3442363693316475,
            -0.5817781819508783,
            0.35114374833485607,
            1.1229502716222781,
            0.45619247794084083,
            0.08783351766172355,
        ],
        [
            0.06361430009419232,
            0.6926810562240848,
            -0.4297785211478541,
            -0.46202875308860125,
            -0.36949007474336926,
            0.8488609929914562,
            0.030242445794160633,
            -0.14503901054294097,
            0.2058457533515663,
            0.2491580414140638,
        ],
    ],
    [
        [0.1798820030601053],
        [
            -0.1533759903297747,
            0.2964688376499158,
            -0.14860837418627715,
            -0.5551072496477686,
            0.19870817329497556,
            -0.3760368493600557,
            0.4044751294601737,
            -0.32878881969363477,
            -0.5566640994443255,
        ],
        [0.5598006445911394, 0.4954191143909883, 0.7768169558982286],
        [
            0.035077508613607256,
            -0.18338072549214748,
            -0.11985026451776065,
            0.7471592115103867,
            0.34655767438419205,
            0.22412820486882898,
            0.6981705844979219,
            0.3181720496138494,
        ],
        [
            0.18466074016625922,
            0.5419495972646897,
            0.5887579351606795,
            -0.5653359894384714,
            0.16017679421854783,
            -0.49769950032627924,
            -0.6930225262597705,
            0.3904417023562996,
            0.6252695138324811,
            -0.5591798774189761,
        ],
    ],
]

# When testing that exp(Ms[i], ps[i], t * vs[i]) is an extremum of the length functional, we parametrize curves in Ms[i] and take a derivative along dys[i]
dys = [
    [
        0.24768051036976024,
        0.15340874919881428,
        0.10461792180729243,
        0.1621738878738882,
        0.13788895788409475,
        0.13920478959340893,
        0.1980520199776914,
        0.225220769065586,
        0.09192923424127934,
        0.15861132814448145,
        0.07788788182581427,
        0.2033127058413462,
        0.11406283238286104,
        0.020870012361419343,
        0.2719578430552649,
        0.15170700765742606,
        0.07022129511933332,
        0.04843952826362164,
        0.2555544578976192,
        0.06681340738035137,
        0.15586613310716685,
        0.018646851863471762,
        0.1979297092698637,
        0.23753411269988997,
        0.21343310337377225,
        0.08016910818336964,
        0.1464783972931314,
        0.025950651929534232,
        0.1449831966165307,
        0.23373068876892722,
        0.11880598168141776,
        0.19121899600576953,
        0.15179084381364852,
        0.04935589775227154,
        0.1560593153225572,
        0.04411343229804097,
        0.2392666728301238,
        0.1484349911958273,
        0.17060958026859915,
        0.01433037040599356,
    ],
    [
        0.2703013619564934,
        0.1674196883015804,
        0.11417275710290055,
        0.17698535383607492,
        0.15048246250457872,
        0.15191847013635482,
        0.2161402633508973,
        0.2457903551976426,
        0.10032520193833194,
        0.1730974227854145,
        0.08500144200281991,
        0.22188141170224845,
        0.12448027862860386,
        0.022776086648557087,
        0.29679596211605436,
        0.16556252539583352,
        0.07663466003347703,
        0.05286354765112583,
        0.278894443170582,
        0.07291552728513738,
        0.17010150697308607,
        0.020349883191748984,
        0.21600678191201325,
        0.2592282859804155,
        0.23292611292832396,
        0.08749101451887183,
        0.15985638202387917,
        0.02832074493766232,
        0.1582246235190211,
        0.255077492415341,
        0.12965662340215453,
        0.20868317404203518,
    ],
    [
        0.16353440643700792,
        0.10129020125571776,
        0.06907539765598648,
        0.10707750259980159,
        0.0910430491609086,
        0.09191184484141025,
        0.13076652451317197,
        0.14870505851042468,
        0.06069752009721213,
        0.1047252743607885,
        0.05142652727905344,
        0.13423996349664308,
        0.07531152759015192,
        0.013779707893699597,
        0.17956384365300332,
        0.10016660338980309,
        0.04636455972831437,
        0.03198285359980099,
        0.16873328677427074,
        0.0441144557626597,
        0.10291272221322205,
        0.012311836110395775,
        0.1306857672142806,
        0.1568351101623881,
        0.14092209282890691,
        0.05293273783140711,
        0.09671434268855209,
        0.017134268875714943,
        0.09572711622173373,
        0.1543238480770115,
        0.07844325605769907,
        0.12625492803046978,
        0.10022195734569302,
        0.03258789894704945,
        0.10304027338340047,
        0.029126490235301297,
        0.15797905641835802,
        0.09800621027247283,
        0.11264728258206483,
        0.009461820854890907,
        0.07619899497188476,
        0.06435512726649247,
        0.14418724370624061,
        0.020482591380646117,
        0.18622326856315144,
        0.17680302406232687,
        0.11411324587011096,
        0.04559115895133764,
        0.024318253167761508,
        0.0777066933426362,
        0.16696701026147626,
        0.06641466684484068,
        0.06421006278332052,
        0.1069248857665583,
        0.12159103864374035,
        0.05073753945931583,
        0.04924168633871106,
        0.12722583436268306,
        0.18563179386637813,
        0.0687128870870491,
        0.08905886988994213,
        0.009035432164352614,
        0.049561446318667116,
        0.1347085017272271,
        0.1200359392924501,
        0.027268283817115106,
        0.04224558795450571,
        0.04315262171954351,
        0.05403346926811662,
        0.0023262859537098515,
        0.010721414504714139,
        0.13403654903491943,
        0.10987330337776338,
        0.013298908898025385,
        0.14340914694684173,
        0.17825169707180502,
        0.10868078009526573,
        0.0016445884181541684,
        0.07063958523304881,
        0.1101738445443299,
        0.11758054831650003,
        0.060827727766064016,
        0.14865227744166581,
        0.11702503201869387,
        0.09342064187053477,
        0.15738531812684184,
        0.03201521439082036,
        0.06114448967602477,
        0.10382777552410098,
        0.1431354723068435,
        0.18877393058117947,
        0.04238816261102419,
    ],
    [
        0.1715795373556408,
        0.1062732072642473,
        0.07247358541051933,
        0.11234521687243985,
        0.0955219430260548,
        0.09643347940647069,
        0.13719962830095694,
        0.15602065459839623,
        0.0636835553069129,
        0.10987726996268543,
        0.053956472834027505,
        0.14084394430027286,
        0.07901650388441198,
        0.014457605324831525,
        0.1883975482043314,
        0.10509433361797467,
        0.04864548006260954,
        0.03355626099441541,
        0.17703417838482685,
        0.046284681464683716,
        0.10797554869382073,
        0.0129175210883459,
        0.1371148981191942,
        0.164550666915154,
        0.14785480326481754,
        0.05553678192838664,
        0.1014722377736982,
        0.01797719507885178,
        0.10043644436402703,
        0.1619158624347057,
        0.08230229880238973,
        0.1324660822900412,
        0.10515241073061003,
        0.03419107175394852,
        0.10810937478733341,
        0.030559377859677404,
        0.16575088999747303,
        0.10282765922416374,
        0.11818900408120409,
        0.009927298359990544,
        0.07994763052677145,
        0.06752109970877263,
        0.15128058435355177,
        0.021490239451779292,
        0.19538458579496817,
        0.1855009091519671,
        0.1197270859333567,
        0.047834031570543896,
        0.02551459792914639,
        0.08152950063326206,
        0.17518100929637484,
        0.06968195903934253,
        0.06736889872885857,
        0.11218509200201603,
        0.1275727512737259,
        0.053233590023432004,
        0.05166414789821036,
        0.13348475269051732,
        0.19476401329869034,
        0.07209324101046329,
        0.09344015137889938,
        0.009479933332347762,
        0.051999638579474684,
        0.14133553242896432,
        0.12594114827928685,
        0.028609756342773685,
        0.04432387406709532,
        0.04527552966766203,
        0.056691664223667886,
        0.002440728384874828,
        0.011248858149159562,
        0.14063052279470464,
        0.11527855802353276,
        0.013953153258528188,
        0.15046420885860654,
        0.18702085012439856,
        0.11402736815129268,
        0.0017254945064788542,
        0.07411472372909801,
        0.11559388441532585,
        0.10893561836452229,
        0.15017707070132247,
        0.198060728501197,
        0.04447346273248423,
    ],
    [
        0.24768051036976024,
        0.15340874919881428,
        0.10461792180729243,
        0.1621738878738882,
        0.13788895788409475,
        0.13920478959340893,
        0.1980520199776914,
        0.225220769065586,
        0.09192923424127934,
        0.15861132814448145,
        0.07788788182581427,
        0.2033127058413462,
        0.11406283238286104,
        0.020870012361419343,
        0.2719578430552649,
        0.15170700765742606,
        0.07022129511933332,
        0.04843952826362164,
        0.2555544578976192,
        0.06681340738035137,
        0.15586613310716685,
        0.018646851863471762,
        0.1979297092698637,
        0.23753411269988997,
        0.21343310337377225,
        0.08016910818336964,
        0.1464783972931314,
        0.025950651929534232,
        0.1449831966165307,
        0.23373068876892722,
        0.11880598168141776,
        0.19121899600576953,
        0.15179084381364852,
        0.04935589775227154,
        0.1560593153225572,
        0.04411343229804097,
        0.2392666728301238,
        0.1484349911958273,
        0.17060958026859915,
        0.01433037040599356,
    ],
    [
        0.24768051036976024,
        0.15340874919881428,
        0.10461792180729243,
        0.1621738878738882,
        0.13788895788409475,
        0.13920478959340893,
        0.1980520199776914,
        0.225220769065586,
        0.09192923424127934,
        0.15861132814448145,
        0.07788788182581427,
        0.2033127058413462,
        0.11406283238286104,
        0.020870012361419343,
        0.2719578430552649,
        0.15170700765742606,
        0.07022129511933332,
        0.04843952826362164,
        0.2555544578976192,
        0.06681340738035137,
        0.15586613310716685,
        0.018646851863471762,
        0.1979297092698637,
        0.23753411269988997,
        0.21343310337377225,
        0.08016910818336964,
        0.1464783972931314,
        0.025950651929534232,
        0.1449831966165307,
        0.23373068876892722,
        0.11880598168141776,
        0.19121899600576953,
        0.15179084381364852,
        0.04935589775227154,
        0.1560593153225572,
        0.04411343229804097,
        0.2392666728301238,
        0.1484349911958273,
        0.17060958026859915,
        0.01433037040599356,
    ],
    [
        0.16353440643700792,
        0.10129020125571776,
        0.06907539765598648,
        0.10707750259980159,
        0.0910430491609086,
        0.09191184484141025,
        0.13076652451317197,
        0.14870505851042468,
        0.06069752009721213,
        0.1047252743607885,
        0.05142652727905344,
        0.13423996349664308,
        0.07531152759015192,
        0.013779707893699597,
        0.17956384365300332,
        0.10016660338980309,
        0.04636455972831437,
        0.03198285359980099,
        0.16873328677427074,
        0.0441144557626597,
        0.10291272221322205,
        0.012311836110395775,
        0.1306857672142806,
        0.1568351101623881,
        0.14092209282890691,
        0.05293273783140711,
        0.09671434268855209,
        0.017134268875714943,
        0.09572711622173373,
        0.1543238480770115,
        0.07844325605769907,
        0.12625492803046978,
        0.10022195734569302,
        0.03258789894704945,
        0.10304027338340047,
        0.029126490235301297,
        0.15797905641835802,
        0.09800621027247283,
        0.11264728258206483,
        0.009461820854890907,
        0.07619899497188476,
        0.06435512726649247,
        0.14418724370624061,
        0.020482591380646117,
        0.18622326856315144,
        0.17680302406232687,
        0.11411324587011096,
        0.04559115895133764,
        0.024318253167761508,
        0.0777066933426362,
        0.16696701026147626,
        0.06641466684484068,
        0.06421006278332052,
        0.1069248857665583,
        0.12159103864374035,
        0.05073753945931583,
        0.04924168633871106,
        0.12722583436268306,
        0.18563179386637813,
        0.0687128870870491,
        0.08905886988994213,
        0.009035432164352614,
        0.049561446318667116,
        0.1347085017272271,
        0.1200359392924501,
        0.027268283817115106,
        0.04224558795450571,
        0.04315262171954351,
        0.05403346926811662,
        0.0023262859537098515,
        0.010721414504714139,
        0.13403654903491943,
        0.10987330337776338,
        0.013298908898025385,
        0.14340914694684173,
        0.17825169707180502,
        0.10868078009526573,
        0.0016445884181541684,
        0.07063958523304881,
        0.1101738445443299,
        0.11758054831650003,
        0.060827727766064016,
        0.14865227744166581,
        0.11702503201869387,
        0.09342064187053477,
        0.15738531812684184,
        0.03201521439082036,
        0.06114448967602477,
        0.10382777552410098,
        0.1431354723068435,
        0.18877393058117947,
        0.04238816261102419,
    ],
    [
        0.1490765359911958,
        0.09233526241995971,
        0.06296852894216698,
        0.0976109157574458,
        0.08299404810701023,
        0.08378603465806785,
        0.11920562114578914,
        0.13555823199591513,
        0.0553313289630816,
        0.09546664504785775,
        0.04687997291732666,
        0.12237197777320692,
        0.06865333050063585,
        0.012561461312757724,
        0.16368883089666822,
        0.09131100042306806,
        0.042265527528094815,
        0.029155289884568912,
        0.153815789880318,
        0.040214352413767675,
        0.09381433834769744,
        0.011223362220940966,
        0.11913200349775391,
        0.1429695160437834,
        0.12846334848596738,
        0.04825302129601608,
        0.08816394973267236,
        0.015619449792770343,
        0.08726400271162271,
        0.1406802714694426,
        0.07150818680750592,
        0.11509288921319505,
        0.0913614606055903,
        0.029706843936407743,
        0.0939306128799265,
        0.026551453999575543,
        0.14401232745525105,
        0.08934160493420577,
        0.10268827852213556,
        0.008625313216639324,
        0.06946233801138785,
        0.05866557169947423,
        0.13143983149579208,
        0.018671751331583056,
        0.16975950445661273,
        0.161172091881058,
        0.1040246378463513,
        0.04156050213755719,
        0.022168307101803907,
        0.07083674267232855,
        0.15220566764447255,
        0.06054302998342982,
        0.058533332184146566,
        0.09747179158578337,
        0.11084132839998145,
        0.046251897641031985,
        0.044888291006624594,
        0.11597795894213936,
        0.1692203212911706,
        0.06263806747503713,
        0.08118528762078707,
        0.008236621012006807,
        0.04517978141038145,
        0.12279909313025451,
        0.10942371341935776,
        0.0248575292652322,
        0.038510708849485854,
        0.0393375529042932,
        0.049256438455844605,
        0.002120621948981863,
        0.00977354778184982,
        0.12218654692727692,
        0.10015954331772974,
        0.012123169149384955,
        0.13073052528871054,
        0.16249268953840867,
        0.09907244951333158,
        0.0014991924320470194,
        0.06439442866999417,
        0.10043351401912919,
        0.1071854004601844,
        0.055450025136289674,
        0.13551011723482043,
        0.10667899665704653,
        0.08516144084638168,
        0.14347108081661994,
        0.029184789698902848,
        0.0557387825256351,
        0.026753030352160315,
        0.057506912662784994,
        0.16716809419341475,
        0.11576080110723733,
        0.01392399094397694,
        0.0701719259281324,
        0.06969711242341488,
        0.1702065083755876,
        0.13916687524684004,
        0.05350498510320062,
        0.1415754204215561,
        0.06957602019036072,
        0.15092969351716987,
        0.028763669977259567,
        0.09378263985254962,
        0.07190282975849477,
        0.09464849295042106,
        0.13048104587817877,
        0.1720846656652933,
        0.03864067866059161,
    ],
]

# Xs[i] is coordinates for a tangent vector at ps[i]
Xs = [
    [
        -0.597609995187605,
        -0.4256244780566225,
        0.039001131483688445,
        0.2861310539156201,
        -0.5445479395430848,
        0.5398107502679328,
        -0.370911828798264,
        0.9784991722126772,
        -0.858313200235999,
        0.6327050201672981,
    ],
    [
        0.20291047527778772,
        -0.33259407228555404,
        0.2518919563557016,
        0.7589380540013582,
        0.5699565849101806,
        -0.0840258727078147,
        0.17702183701764684,
        -0.020864846013727956,
    ],
    [
        -0.33715222274078416,
        -0.26704690491931915,
        -0.5195355208430397,
        0.645753717662719,
        0.10444433627227578,
        0.33684638019021196,
        0.06539241093725567,
        0.09555909109964422,
        0.7542247481144044,
        -0.20290163218931467,
        -0.2664420819862636,
        0.339548396803274,
        0.9402884626822843,
        -0.6574225234652968,
        0.07702642759782674,
        -0.5460026086958019,
        -0.6357161050460245,
        -0.5843960906310703,
        -0.2548940878123618,
        0.6267033715997288,
        0.08231062546698587,
        0.15159625893365325,
        -0.12967230344148017,
    ],
    [
        -0.34597205746030824,
        0.9028413427061659,
        0.32181983134495096,
        0.9413815779327186,
        0.16359943156565016,
        0.7838434998605843,
        -0.35087705212133735,
        -0.2339200570289206,
        -0.9229212375554967,
        0.9129319387405792,
        -0.9083283912242541,
        0.13034732808854765,
        0.9882693345252747,
        0.19949043337639316,
        0.5191850007789172,
        0.6832919121607344,
        0.08923979072216182,
        -0.1641363924011765,
        0.060902972183083826,
        -0.13189846296393637,
        0.8496859744073246,
    ],
    [
        -0.3508209068712791,
        0.5477811869201115,
        0.9576443316471701,
        0.3815048454137753,
        -0.3581096313769696,
        -0.3297365896057076,
        0.46016273166688904,
        -0.8346220116109249,
        -0.3150517800054915,
        0.5838284430955387,
    ],
    [
        0.30756479319371266,
        -0.43184860921312285,
        0.37624726262849206,
        0.8139529250407125,
        -0.585675532332042,
        -0.5857479127690419,
        -0.45612298630613823,
        0.2559126942459271,
        -0.7348456829025003,
        -0.8876636700373159,
    ],
    [
        0.5526596524494152,
        0.9690315932495712,
        -0.8680156139856099,
        0.39561955960098705,
        -0.7189141230781315,
        0.1091438241240188,
        -0.1514792667377174,
        -0.8842187642857129,
        -0.90929587555064,
        0.0553477365473245,
        -0.38102440387803127,
        -0.21972849843690567,
        -0.1366925641984078,
        0.234658614104986,
        0.6618349090074298,
        0.3456641681297574,
        -0.13000537043751015,
        0.015349401356097525,
        0.4014083014273322,
        -0.05782560373055445,
        -0.3626979339434868,
        -0.46909114377791794,
        0.037734998042463275,
    ],
    [
        -0.6945216072262328,
        0.06573632900997772,
        -0.106647523045865,
        0.13865277008666044,
        -0.7820633695316517,
        -0.10880551946361727,
        0.2658232882927578,
        -0.08490107870171215,
        0.8401971948812119,
        -0.5389907554930264,
        0.9847445142919777,
        0.6022812602894703,
        0.45645830164530143,
        -0.24553265752254427,
        0.06468186895698413,
        0.692893319789019,
        -0.19092820288195367,
        0.45737634128864624,
        0.10728439355457109,
        0.5890201396380044,
        -0.9502112271317584,
        -0.2302405122715243,
        0.8242967867244597,
        -0.7636718337376485,
        -0.2653389884306485,
        0.500710013837995,
        -0.24084472766713083,
    ],
]

for (M, V, p, q, v, u, dy, X) in zip(Ms, Vs, ps, qs, vs, us, dys, Xs)
    @testset "Manifold $M" begin
        @testset "is_point" begin
            @test(is_point(M, p))
            @test(is_point(M, q))
            @test_throws DomainError is_point(M, [[1.0, 0.0], p[2:end]...], true)
            @test_throws DomainError is_point(M, [[-1.0], p[2:end]...], true)
            @test_throws DomainError is_point(M, [p[1], 2 * p[2:end]...], true)
        end

        @testset "is_vector" begin
            @test(is_vector(M, p, v))
            @test(is_vector(M, p, u))
            @test_throws DomainError is_vector(M, [[1.0, 0.0], p[2:end]...], v, false, true)
            @test_throws DomainError is_vector(M, p, [[1.0, 0.0], v[2:end]...], false, true)
            @test_throws DomainError is_vector(M, p, p, false, true)
        end

        Random.seed!(1)
        @testset "rand" begin
            @test(is_point(M, rand(M)))
            @test(is_vector(M, p, rand(M, vector_at=p)))
        end

        @testset "get_embedding" begin
            @test(get_embedding(M) == Euclidean(prod(V)))
        end

        @testset "embed!" begin
            p_ = zeros(prod(V))
            p__ = zeros(prod(V))
            embed!(M, p_, p)
            embed!(M, p__, [p[1], [-x for x in p[2:end]]...])
            @test(is_point(get_embedding(M), p_))
            @test(isapprox(p_, (-1)^length(V) * p__))
        end

        # ManifoldsBase doesn't export embed_vector! right now
        # @testset "embed_vector!" begin
        #     p_ = zeros(prod(V))
        #     v_ = zeros(prod(V))
        #     embed!(M, p_, p)
        #     embed_vector!(M, v_, p, v)
        #     @test(is_vector(get_embedding(M), p_, v_))
        # end

        @testset "get_coordinates" begin
            @test(isapprox(v, get_vector(M, p, get_coordinates(M, p, v))))
            @test(isapprox(X, get_coordinates(M, p, get_vector(M, p, X))))
            @test(
                isapprox(
                    dot(X, get_coordinates(M, p, v)),
                    inner(M, p, v, get_vector(M, p, X)),
                )
            )
        end

        @testset "exp" begin
            # Zero vector
            p_ = exp(M, p, zeros.(size.(v)))
            @test(is_point(M, p_))
            @test(isapprox(p, p_; atol=1e-5))

            # Tangent vector in the scaling direction
            p_ = exp(M, p, [v[1], zeros.(size.(v[2:end]))...])
            @test(is_point(M, p_))
            @test(isapprox([p[1] + v[1], p[2:end]...], p_; atol=1e-5))

            # Generic tangent vector
            p_ = exp(M, p, v)
            @test(is_point(M, p))

            geodesic_speed = central_fdm(3, 1)(t -> distance(M, p, exp(M, p, t * v)), -1.0)
            @test(isapprox(geodesic_speed, -norm(M, p, v); atol=1e-5))
            geodesic_speed =
                central_fdm(3, 1)(t -> distance(M, p, exp(M, p, t * v)), -0.811)
            @test(isapprox(geodesic_speed, -norm(M, p, v); atol=1e-5))
            geodesic_speed =
                central_fdm(3, 1)(t -> distance(M, p, exp(M, p, t * v)), -0.479)
            @test(isapprox(geodesic_speed, -norm(M, p, v); atol=1e-5))
            geodesic_speed = central_fdm(3, 1)(t -> distance(M, p, exp(M, p, t * v)), 0.181)
            @test(isapprox(geodesic_speed, norm(M, p, v); atol=1e-5))
            geodesic_speed = central_fdm(3, 1)(t -> distance(M, p, exp(M, p, t * v)), 0.703)
            @test(isapprox(geodesic_speed, norm(M, p, v); atol=1e-5))
            geodesic_speed = central_fdm(3, 1)(t -> distance(M, p, exp(M, p, t * v)), 1.0)
            @test(isapprox(geodesic_speed, norm(M, p, v); atol=1e-5))

            # Geodesics are (locally) length-minizing. So let B_a be a one-parameter
            # family of curves such that B_0 is a geodesic. Then the derivative of
            # length(B_a) at a = 0 should be 0, and the second derivative should be
            # nonnegative.

            n = manifold_dimension(M)
            x = get_coordinates(M, p, v)
            x0 = 0.0 * x
            x1 = 0.2 * x
            x2 = 0.4 * x
            x3 = 0.6 * x
            x4 = 0.8 * x
            x5 = 1.0 * x

            function curve_length(y::Vector{Float64})
                @assert(length(y) == 4 * n)

                # Control points
                y1 = y[1:n]
                y2 = y[(n + 1):(2 * n)]
                y3 = y[(2 * n + 1):(3 * n)]
                y4 = y[(3 * n + 1):(4 * n)]

                # Bezier curve from 0 to v with control points y1, ..., y4
                function b(t)
                    return (
                        (1 - t)^5 * x0 +
                        5 * t * (1 - t)^4 * (x1 + y1) +
                        10 * t^2 * (1 - t)^3 * (x2 + y2) +
                        10 * t^3 * (1 - t)^2 * (x3 + y3) +
                        5 * t^4 * (1 - t) * (x4 + y4) +
                        t^5 * x5
                    )
                end

                # Length of curve on manifold
                ps_ = [exp(M, p, get_vector(M, p, b(t))) for t in 0.0:1e-3:1.0]
                ds = [distance(M, p1, p2) for (p1, p2) in zip(ps_[1:(end - 1)], ps_[2:end])]
                return sum(ds)
            end

            # dy = rand(4 * n); dy = dy / norm(dy)
            f = a -> curve_length(a * dy)
            @test(isapprox(central_fdm(3, 1)(f, 0.0), 0.0; atol=1e-5))
            @test(central_fdm(3, 2)(f, 0.0) >= 0.0)
        end

        @testset "log" begin
            # Same point
            v_ = log(M, p, p)
            @test(is_vector(M, p, v_))
            @test(isapprox(zeros.(size.(v)), v_; atol=1e-5))

            # Scaled point
            v_ = log(M, p, [q[1], p[2:end]...])
            @test(is_vector(M, p, v_))
            @test(isapprox(v_, [q[1] - p[1], zeros.(size.(q[2:end]))...]; atol=1e-5))

            # Generic tangent vector
            v_ = log(M, p, q)
            @test(is_vector(M, p, v_))
        end

        @testset "norm" begin
            @test(isapprox(norm(M, p, log(M, p, q)), distance(M, p, q)))
        end

        @testset "sectional_curvature" begin
            # Test that sectional curvature is difference between circumference
            # and 2 pi r for small circles.

            # Orthonormalize
            u_ = u / norm(M, p, u)
            v_ = v - inner(M, p, u_, v) * u_
            v_ = v_ / norm(M, p, v_)

            r = 1e-2
            ps_ = [
                exp(M, p, r * (cos(theta) * u_ + sin(theta) * v_)) for
                theta in 0.0:1e-3:(2 * pi)
            ]
            ds = [distance(M, p1, p2) for (p1, p2) in zip(ps_, [ps_[2:end]..., ps_[1]])]
            C = sum(ds)
            K = 3 * (2 * pi * r - C) / (pi * r^3) # https://en.wikipedia.org/wiki/Bertrand%E2%80%93Diguet%E2%80%93Puiseux_theorem

            @test(isapprox(K, sectional_curvature(M, p, u, v); rtol=1e-2, atol=1e-2))
        end

        @testset "riemann_tensor" begin
            @test(
                isapprox(
                    sectional_curvature(M, p, u, v),
                    inner(M, p, riemann_tensor(M, p, u, v, v), u) /
                    (inner(M, p, u, u) * inner(M, p, v, v) - inner(M, p, u, v)^2),
                )
            )
        end
    end
end
